source config.personal

project_dir=/Users/mac/Workspace/Stargaze

if [ "$1" == "boom" ]; then
  rsync -rtvu --progress --rsh="ssh -p$port" ../../Stargaze/ $ip:$project_dir/
  ssh $ip -p $port "cd $project_dir/Stargaze; make alt_debug"
elif [ "$1" == "debug" ]; then
  rsync -rtvu --progress --rsh="ssh -p$port" ../../Stargaze/ $ip:$project_dir/
  echo 'Building and relaunching simulator...'
  ssh $ip -p $port "cd $project_dir/Stargaze; make AppBundle; ruby launcher.rb"
  echo 'Done!'
elif [ "$1" == "log" ]; then
  echo 'Started log from Macbox'
  ssh -t -t $ip -p $port 'tail -f /var/log/system.log | grep test'
elif [ "$1" == "ssh" ]; then
  ssh $ip -p $port
elif [ "$1" == "fallback" ]; then
  time=$(date +"%Y-%m-%d %H:%M")
  commit_msg="Magic happened at $time"

  git checkout magic
  git add .
  git commit -m "$commit_msg"
  git push origin magic

  ssh $ip -p $port "cd $project_dir/Stargaze; git pull origin magic; make alt_debug"
  echo "Magic done!"
elif [ "$1" == "init" ]; then
  ssh $ip -p $port 'cd $project_dir/Stargaze; make init'
elif [ "$1" == "test" ]; then
  test_file=$2
  command="cucumber $project_dir/Frank/features/$test_file --f pretty"
  ssh $ip -p $port $command
  echo "Started log from Macbox."
  ssh -t -t $ip -p $port 'tail -f /var/log/system.log | grep test'
elif [ "$1" == "build_and_test" ]; then
  test_file=$2
  rsync -rtvuq --progress --rsh="ssh -p$port" ../../Stargaze/ $ip:$project_dir/
  command="cd $project_dir; frank build; cucumber $project_dir/Frank/features/$test_file --f pretty"
  ssh $ip -p $port $command
elif [ "$1" == "test_log" ]; then
  echo 'Started test log from Macbox'
  ssh -t -t $ip -p $port 'tail -f /var/log/system.log | grep Stargaze'
elif [ "$1" == "quiet_build" ] || [ "$1" == "sublime_build" ]; then
  start=$(date +"%s")
  rsync -rtvuq --progress --rsh="ssh -p$port" ../../Stargaze/ $ip:$project_dir/
  echo "Sync done! Building app and launching..."
  ssh $ip -p $port "ruby $project_dir/Stargaze/builder.rb; ruby $project_dir/Stargaze/launcher.rb"
  echo "Command done in $(($(date +"%s")-$start))s! Started log from Macbox."
  ssh -t -t $ip -p $port 'tail -f /var/log/system.log | grep test'
elif [ "$1" == "sublime_test" ]; then
  test_file=$2
  rsync -rtvuq --progress --rsh="ssh -p$port" ../../Stargaze/ $ip:$project_dir/
  command="cd $project_dir; frank build; cucumber $project_dir/Frank/features/$test_file --f pretty"
  ssh $ip -p $port $command
  echo 'Started test log from Macbox'
  ssh -t -t $ip -p $port 'tail -f /var/log/system.log | grep Stargaze'
elif [ "$1" ]; then
  command="$@"
  echo "Executing '$command' on $ip:$port"
  ssh $ip -p $port $command
else
  cat <<EOF
Magic usage:

bash magic [command]

debug - Update Macbox, rerun simulator and open the app (via Frank direct loader)
boom - Update Macbox and rerun updated simulator (regular way)
log - Tail application log (for NSLOG)
ssh - SSH into Macbox
init - test [feature_file] (f.e. clean_start.feature)
fallback - Fallback Macbox update via Github (magic branch) and rerun simulator with app already started
[any_other_command] - Runs any command

If magic returns error: “[kill_simulator] Error 1”
just run “bash magic init” to initialize first simulator.

EOF
fi
exit 0